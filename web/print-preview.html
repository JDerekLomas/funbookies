<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Funbookies - Print Preview</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Nunito', sans-serif;
      background: #2a2a2a;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }

    .controls {
      display: flex;
      gap: 15px;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      justify-content: center;
    }

    select, button {
      padding: 10px 20px;
      font-size: 1rem;
      font-family: inherit;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    select { background: white; }

    button {
      background: #667eea;
      color: white;
      font-weight: 600;
    }
    button:hover { background: #5a6fd6; }
    button:disabled { opacity: 0.4; cursor: not-allowed; }

    .page-info {
      color: white;
      font-size: 1rem;
      min-width: 120px;
      text-align: center;
    }

    /* Page container - 10x10cm at 400px */
    .page-container {
      width: 400px;
      height: 400px;
      position: relative;
      border-radius: 4px;
      overflow: hidden;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    }

    .page {
      width: 100%;
      height: 100%;
      position: relative;
      background: #FFF8E7;
    }

    .page img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* Text box - FULLY OPAQUE, at bottom */
    .text-box {
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 14px 20px;
      background: #FFFFFF;
      font-family: 'Nunito', sans-serif;
      font-size: 20px;
      font-weight: 700;
      line-height: 1.4;
      text-align: center;
      color: #333;
      border-top: 3px solid #FFB347;
    }

    /* Cover title at bottom */
    .text-box.cover {
      font-size: 26px;
      font-weight: 900;
      color: #FF6B35;
      background: #FFF8DC;
      border-top: 4px solid #FF6B35;
    }

    /* Word list page */
    .wordlist-page {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #FFFEF5;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }

    .wordlist-page h2 {
      text-align: center;
      font-size: 22px;
      font-weight: 800;
      color: #333;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #ddd;
    }

    .word-table {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .word-row {
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }

    .word-label {
      width: 100px;
      font-size: 11px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding-top: 4px;
      flex-shrink: 0;
    }

    .word-label.sound-out { color: #1565C0; }
    .word-label.sight { color: #7B1FA2; }
    .word-label.new { color: #E65100; }

    .word-list {
      flex: 1;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .word-chip {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 600;
    }

    .word-chip.sound-out { background: #E3F2FD; color: #1565C0; }
    .word-chip.sight { background: #F3E5F5; color: #7B1FA2; }
    .word-chip.new { background: #FFF3E0; color: #E65100; }

    /* The End styling */
    .text-box.end {
      font-size: 24px;
      font-weight: 800;
      color: #666;
      font-style: italic;
    }

    /* Thumbnails */
    .thumbnails {
      display: flex;
      gap: 6px;
      margin-top: 20px;
      flex-wrap: wrap;
      justify-content: center;
      max-width: 800px;
    }

    .thumb {
      width: 45px;
      height: 45px;
      border-radius: 4px;
      overflow: hidden;
      cursor: pointer;
      border: 2px solid transparent;
      transition: border-color 0.2s, transform 0.2s;
      position: relative;
    }
    .thumb:hover { transform: scale(1.1); }
    .thumb.active { border-color: #667eea; }
    .thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .thumb .num {
      position: absolute;
      bottom: 1px;
      right: 1px;
      background: rgba(0,0,0,0.7);
      color: white;
      font-size: 8px;
      padding: 1px 3px;
      border-radius: 2px;
    }

    .hint {
      color: #888;
      font-size: 0.85rem;
      margin-top: 15px;
    }
  </style>
</head>
<body>
  <div class="controls">
    <select id="bookSelect" onchange="loadBook(this.value)">
      <option value="volcano_curated">Gus and the Volcano</option>
    </select>
    <button onclick="prevPage()" id="prevBtn">← Prev</button>
    <div class="page-info" id="pageInfo">Page 1 / 22</div>
    <button onclick="nextPage()" id="nextBtn">Next →</button>
  </div>

  <div class="page-container">
    <div class="page" id="pageView"></div>
  </div>

  <div class="thumbnails" id="thumbnails"></div>

  <div class="hint">Use ← → arrow keys to navigate</div>

  <script>
    let currentBook = null;
    let currentPage = 0;

    async function loadBook(bookKey) {
      try {
        const res = await fetch(`/books/${bookKey}.json`);
        if (res.ok) {
          currentBook = await res.json();
          currentBook.key = bookKey;
          currentPage = 0;
          renderPage();
          renderThumbnails();
        }
      } catch (e) {
        console.error('Failed to load book:', e);
      }
    }

    function renderPage() {
      if (!currentBook) return;

      const page = currentBook.pages[currentPage];
      const pageView = document.getElementById('pageView');
      const imgPath = `/books/images/${page.image}`;

      // Word list page
      if (page.type === 'wordlist') {
        const wl = currentBook.word_list;
        pageView.innerHTML = `
          <div class="wordlist-page">
            <h2>Words to Know</h2>
            <div class="word-table">
              <div class="word-row">
                <div class="word-label sound-out">Sound out</div>
                <div class="word-list">
                  ${(wl.sound_out || []).map(w => `<span class="word-chip sound-out">${w}</span>`).join('')}
                </div>
              </div>
              <div class="word-row">
                <div class="word-label sight">Sight words</div>
                <div class="word-list">
                  ${(wl.sight || []).map(w => `<span class="word-chip sight">${w}</span>`).join('')}
                </div>
              </div>
              <div class="word-row">
                <div class="word-label new">New words</div>
                <div class="word-list">
                  ${(wl.new || []).map(w => `<span class="word-chip new">${w}</span>`).join('')}
                </div>
              </div>
            </div>
          </div>
        `;
      }
      // Cover page
      else if (page.type === 'cover') {
        pageView.innerHTML = `
          <img src="${imgPath}" onerror="this.style.display='none'" alt="">
          <div class="text-box cover">${page.text}</div>
        `;
      }
      // Story pages
      else {
        const textClass = page.text === 'The End' ? 'text-box end' : 'text-box';
        const displayText = page.text.replace(/\n/g, '<br>');
        pageView.innerHTML = `
          <img src="${imgPath}" onerror="this.style.display='none'" alt="">
          <div class="${textClass}">${displayText}</div>
        `;
      }

      // Update controls
      document.getElementById('pageInfo').textContent = `Page ${currentPage + 1} / ${currentBook.pages.length}`;
      document.getElementById('prevBtn').disabled = currentPage === 0;
      document.getElementById('nextBtn').disabled = currentPage === currentBook.pages.length - 1;

      // Update thumbnail active state
      document.querySelectorAll('.thumb').forEach((t, i) => {
        t.classList.toggle('active', i === currentPage);
      });
    }

    function renderThumbnails() {
      if (!currentBook) return;

      const container = document.getElementById('thumbnails');
      container.innerHTML = currentBook.pages.map((page, i) => {
        const imgPath = `/books/images/${page.image}`;
        return `
          <div class="thumb ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">
            <img src="${imgPath}" onerror="this.style.background='#ddd'" alt="">
            <span class="num">${i + 1}</span>
          </div>
        `;
      }).join('');
    }

    function goToPage(index) {
      currentPage = index;
      renderPage();
    }

    function prevPage() {
      if (currentPage > 0) {
        currentPage--;
        renderPage();
      }
    }

    function nextPage() {
      if (currentBook && currentPage < currentBook.pages.length - 1) {
        currentPage++;
        renderPage();
      }
    }

    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft') prevPage();
      if (e.key === 'ArrowRight') nextPage();
    });

    loadBook('volcano_curated');
  </script>
</body>
</html>
