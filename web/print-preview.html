<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Funbookies - Print Preview</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Nunito', sans-serif;
      background: #2a2a2a;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }

    .controls {
      display: flex;
      gap: 15px;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      justify-content: center;
    }

    select, button {
      padding: 10px 20px;
      font-size: 1rem;
      font-family: inherit;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    select {
      background: white;
    }

    button {
      background: #667eea;
      color: white;
      font-weight: 600;
    }
    button:hover { background: #5a6fd6; }
    button:disabled { opacity: 0.4; cursor: not-allowed; }

    .page-info {
      color: white;
      font-size: 1rem;
      min-width: 120px;
      text-align: center;
    }

    /* The actual page preview - 10x10cm at screen resolution */
    .page-container {
      width: 400px;
      height: 400px;
      position: relative;
      border-radius: 4px;
      overflow: hidden;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    }

    .page {
      width: 100%;
      height: 100%;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .page img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .page .text-overlay {
      position: absolute;
      left: 5%;
      right: 5%;
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.94);
      border-radius: 10px;
      font-family: 'Nunito', sans-serif;
      font-size: 18px;
      font-weight: 600;
      line-height: 1.4;
      text-align: center;
      color: #333;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    .page .text-overlay.bottom {
      bottom: 6%;
    }

    .page .text-overlay.center {
      top: 50%;
      transform: translateY(-50%);
    }

    .page .text-overlay.cover {
      font-size: 28px;
      font-weight: 800;
      color: #FF6B35;
    }

    .page .text-overlay.wordlist {
      font-size: 14px;
      font-weight: 600;
      text-align: left;
      line-height: 1.8;
    }

    .page .text-overlay.copyright {
      font-size: 12px;
      font-weight: 400;
      color: #666;
      line-height: 1.6;
    }

    /* Page backgrounds by type */
    .page.cover { background: #FFE4B5; }
    .page.wordlist { background: #E8F5E9; }
    .page.wordlist_title { background: #E8F5E9; }
    .page.story { background: #FFF8E7; }
    .page.copyright { background: #F5F5F5; }

    /* Wordlist formatting */
    .wordlist-content h4 {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
      font-weight: 700;
    }
    .wordlist-content h4.sound-out { color: #1565C0; }
    .wordlist-content h4.sight { color: #7B1FA2; }
    .wordlist-content h4.new { color: #E65100; }
    .wordlist-content .words {
      margin-bottom: 10px;
      color: #333;
    }

    /* Thumbnail strip */
    .thumbnails {
      display: flex;
      gap: 8px;
      margin-top: 20px;
      flex-wrap: wrap;
      justify-content: center;
      max-width: 800px;
    }

    .thumb {
      width: 50px;
      height: 50px;
      border-radius: 4px;
      overflow: hidden;
      cursor: pointer;
      border: 2px solid transparent;
      transition: border-color 0.2s, transform 0.2s;
      position: relative;
    }
    .thumb:hover { transform: scale(1.1); }
    .thumb.active { border-color: #667eea; }
    .thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .thumb .num {
      position: absolute;
      bottom: 2px;
      right: 2px;
      background: rgba(0,0,0,0.7);
      color: white;
      font-size: 9px;
      padding: 1px 4px;
      border-radius: 3px;
    }

    /* Keyboard hint */
    .hint {
      color: #888;
      font-size: 0.85rem;
      margin-top: 15px;
    }
  </style>
</head>
<body>
  <div class="controls">
    <select id="bookSelect" onchange="loadBook(this.value)">
      <option value="volcano">Pip and the Volcano</option>
      <option value="castles">Rats in the Castle</option>
      <option value="jungle">Jungle Sloth</option>
    </select>
    <button onclick="prevPage()" id="prevBtn">← Prev</button>
    <div class="page-info" id="pageInfo">Page 1 / 24</div>
    <button onclick="nextPage()" id="nextBtn">Next →</button>
  </div>

  <div class="page-container">
    <div class="page" id="pageView"></div>
  </div>

  <div class="thumbnails" id="thumbnails"></div>

  <div class="hint">Use ← → arrow keys to navigate</div>

  <script>
    let currentBook = null;
    let currentPage = 0;

    const bookFiles = {
      volcano: 'volcano_story.json',
      castles: 'castles_story.json',
      jungle: 'jungle_story.json'
    };

    async function loadBook(bookKey) {
      try {
        const res = await fetch(`/books/${bookFiles[bookKey]}`);
        if (res.ok) {
          currentBook = await res.json();
          currentBook.slug = bookKey;
          currentPage = 0;
          renderPage();
          renderThumbnails();
        }
      } catch (e) {
        console.error('Failed to load book:', e);
      }
    }

    function renderPage() {
      if (!currentBook) return;

      const page = currentBook.pages[currentPage];
      const pageView = document.getElementById('pageView');
      const imgPath = `/books/images/${currentBook.slug}_page${String(page.page).padStart(2, '0')}.png`;

      // Set page type class
      pageView.className = `page ${page.type}`;

      // Determine text position and style
      const isCenter = ['cover', 'wordlist_title', 'copyright'].includes(page.type);
      const posClass = isCenter ? 'center' : 'bottom';

      let textClass = posClass;
      if (page.type === 'cover') textClass += ' cover';
      if (page.type === 'copyright') textClass += ' copyright';

      // Handle wordlist page specially
      if (page.type === 'wordlist' && currentBook.word_list) {
        const wl = currentBook.word_list;
        const soundOut = wl.sound_out || wl.phonetic || [];
        const sight = wl.sight || [];
        const newWords = wl.new || wl.special || [];

        pageView.innerHTML = `
          <img src="${imgPath}" onerror="this.style.display='none'" alt="">
          <div class="text-overlay center wordlist">
            <div class="wordlist-content">
              <strong style="display:block; text-align:center; margin-bottom:10px; font-size:16px;">Words to Know</strong>
              ${soundOut.length ? `<h4 class="sound-out">Sound-out words</h4><div class="words">${soundOut.join(' • ')}</div>` : ''}
              ${sight.length ? `<h4 class="sight">Sight words</h4><div class="words">${sight.join(' • ')}</div>` : ''}
              ${newWords.length ? `<h4 class="new">New words</h4><div class="words">${newWords.join(' • ')}</div>` : ''}
            </div>
          </div>
        `;
      } else {
        pageView.innerHTML = `
          <img src="${imgPath}" onerror="this.style.display='none'" alt="">
          <div class="text-overlay ${textClass}">${page.text}</div>
        `;
      }

      // Update controls
      document.getElementById('pageInfo').textContent = `Page ${currentPage + 1} / ${currentBook.pages.length}`;
      document.getElementById('prevBtn').disabled = currentPage === 0;
      document.getElementById('nextBtn').disabled = currentPage === currentBook.pages.length - 1;

      // Update thumbnail active state
      document.querySelectorAll('.thumb').forEach((t, i) => {
        t.classList.toggle('active', i === currentPage);
      });
    }

    function renderThumbnails() {
      if (!currentBook) return;

      const container = document.getElementById('thumbnails');
      container.innerHTML = currentBook.pages.map((page, i) => {
        const imgPath = `/books/images/${currentBook.slug}_page${String(page.page).padStart(2, '0')}.png`;
        return `
          <div class="thumb ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">
            <img src="${imgPath}" onerror="this.style.background='#ddd'" alt="">
            <span class="num">${page.page}</span>
          </div>
        `;
      }).join('');
    }

    function goToPage(index) {
      currentPage = index;
      renderPage();
    }

    function prevPage() {
      if (currentPage > 0) {
        currentPage--;
        renderPage();
      }
    }

    function nextPage() {
      if (currentBook && currentPage < currentBook.pages.length - 1) {
        currentPage++;
        renderPage();
      }
    }

    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft') prevPage();
      if (e.key === 'ArrowRight') nextPage();
    });

    // Load volcano book by default
    loadBook('volcano');
  </script>
</body>
</html>
