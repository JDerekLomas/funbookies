<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Funbookies - Print Preview</title>
  <link href="https://fonts.googleapis.com/css2?family=Andika:wght@400;700&family=Nunito:wght@700;800;900&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Andika', sans-serif;
      background: #1a1a2e;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }

    .header {
      text-align: center;
      margin-bottom: 15px;
    }
    .header h1 {
      font-family: 'Nunito', sans-serif;
      font-size: 1.5rem;
      font-weight: 900;
      color: #FFB347;
      margin-bottom: 5px;
    }
    .badges {
      display: flex;
      gap: 8px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .level-badge {
      display: inline-block;
      background: #4CAF50;
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 700;
    }
    .version-badge {
      display: inline-block;
      background: #FF5722;
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 700;
    }
    .version-badge.v1 { background: #607D8B; }
    .version-badge.v2 { background: #FF5722; }

    .controls {
      display: flex;
      gap: 15px;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      justify-content: center;
    }

    select, button {
      padding: 10px 20px;
      font-size: 1rem;
      font-family: inherit;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    select { background: white; }

    button {
      background: #667eea;
      color: white;
      font-weight: 700;
    }
    button:hover { background: #5a6fd6; }
    button:disabled { opacity: 0.4; cursor: not-allowed; }

    .page-info {
      color: white;
      font-size: 1rem;
      min-width: 120px;
      text-align: center;
    }

    /* Page container - 10x10cm square at screen scale */
    .page-container {
      width: 400px;
      height: 400px;
      border-radius: 4px;
      overflow: hidden;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
      display: flex;
      flex-direction: column;
      background: white;
    }

    /* IMAGE AREA - top 65% */
    .image-area {
      flex: 65;
      background: #f0f0f0;
      position: relative;
      overflow: hidden;
    }

    .image-area img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* TEXT AREA - bottom 35% */
    .text-area {
      flex: 35;
      background: #FFFEF5;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 15px 20px;
      border-top: 4px solid #FFB347;
    }

    .text-area p {
      font-family: 'Andika', sans-serif;
      font-size: 22px;
      font-weight: 400;
      color: #222;
      text-align: center;
      line-height: 1.4;
      letter-spacing: 0.5px;
    }

    /* COVER PAGE */
    .page-cover .image-area { flex: 70; }
    .page-cover .text-area {
      flex: 30;
      background: linear-gradient(to bottom, #FFF8DC, #FFE4B5);
      border-top: 5px solid #FF6B35;
    }
    .page-cover .text-area p {
      font-family: 'Nunito', sans-serif;
      font-size: 26px;
      font-weight: 900;
      color: #D84315;
      text-shadow: 1px 1px 0 rgba(255,255,255,0.5);
    }

    /* WORD LIST PAGE */
    .page-wordlist {
      background: linear-gradient(135deg, #FFFEF5 0%, #FFF8E1 100%);
      padding: 20px;
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .page-wordlist h2 {
      text-align: center;
      font-family: 'Nunito', sans-serif;
      font-size: 22px;
      font-weight: 800;
      color: #333;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 3px solid #FFB347;
    }

    .word-section {
      margin-bottom: 12px;
      flex: 1;
    }

    .word-section-label {
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .word-section-label::before {
      content: '';
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .word-section-label.sound-out { color: #1565C0; }
    .word-section-label.sound-out::before { background: #1565C0; }
    .word-section-label.sight { color: #7B1FA2; }
    .word-section-label.sight::before { background: #7B1FA2; }
    .word-section-label.new { color: #E65100; }
    .word-section-label.new::before { background: #E65100; }

    .word-boxes {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .word-box {
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 700;
      border: 2px solid;
      font-family: 'Andika', sans-serif;
    }

    .word-box.sound-out {
      background: #E3F2FD;
      color: #0D47A1;
      border-color: #64B5F6;
    }
    .word-box.sight {
      background: #F3E5F5;
      color: #6A1B9A;
      border-color: #BA68C8;
    }
    .word-box.new {
      background: #FFF3E0;
      color: #BF360C;
      border-color: #FFB74D;
    }

    .wordlist-footer {
      text-align: center;
      font-size: 10px;
      color: #888;
      margin-top: auto;
      padding-top: 8px;
      border-top: 1px dashed #ddd;
    }

    /* END PAGE */
    .page-end .image-area { flex: 70; }
    .page-end .text-area {
      flex: 30;
      background: linear-gradient(to bottom, #E8F5E9, #C8E6C9);
      border-top: 4px solid #4CAF50;
    }
    .page-end .text-area p {
      font-family: 'Nunito', sans-serif;
      font-size: 28px;
      font-weight: 800;
      color: #2E7D32;
    }

    /* Thumbnails */
    .thumbnails {
      display: flex;
      gap: 6px;
      margin-top: 20px;
      flex-wrap: wrap;
      justify-content: center;
      max-width: 800px;
    }

    .thumb {
      width: 50px;
      height: 50px;
      border-radius: 6px;
      overflow: hidden;
      cursor: pointer;
      border: 3px solid transparent;
      transition: all 0.2s;
      position: relative;
      background: #ddd;
    }
    .thumb:hover { transform: scale(1.1); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
    .thumb.active { border-color: #FFB347; }
    .thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .thumb .num {
      position: absolute;
      bottom: 2px;
      right: 2px;
      background: rgba(0,0,0,0.8);
      color: white;
      font-size: 9px;
      font-weight: 700;
      padding: 2px 4px;
      border-radius: 3px;
    }

    /* Riso color info */
    .riso-info {
      color: #aaa;
      font-size: 0.75rem;
      margin-top: 15px;
      text-align: center;
      max-width: 400px;
    }
    .riso-info .color-chip {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 3px;
      margin: 0 3px;
      vertical-align: middle;
    }

    .print-info {
      color: #888;
      font-size: 0.8rem;
      margin-top: 20px;
      text-align: center;
      max-width: 400px;
    }
    .print-info strong { color: #FFB347; }

    .hint {
      color: #666;
      font-size: 0.85rem;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Funbookies</h1>
    <div class="badges">
      <span class="level-badge" id="levelBadge">Level 1: CVC Words</span>
      <span class="version-badge" id="versionBadge">v1</span>
    </div>
  </div>

  <div class="controls">
    <select id="bookSelect" onchange="loadBook(this.value)">
      <optgroup label="v1 - Original">
        <option value="volcano_curated">Gus and the Volcano</option>
        <option value="castle_rats">Rats in the Castle</option>
        <option value="jungle_zee">Zee and the Jungle</option>
      </optgroup>
      <optgroup label="v2 - Riso Print Ready">
        <option value="volcano_v2">Gus and the Volcano (Riso)</option>
        <option value="castle_v2">Rats in the Castle (Riso)</option>
        <option value="jungle_v2">Zee and the Jungle (Riso)</option>
      </optgroup>
    </select>
    <button onclick="prevPage()" id="prevBtn">Prev</button>
    <div class="page-info" id="pageInfo">Page 1 / 18</div>
    <button onclick="nextPage()" id="nextBtn">Next</button>
  </div>

  <div class="page-container" id="pageContainer"></div>

  <div class="thumbnails" id="thumbnails"></div>

  <div class="riso-info" id="risoInfo"></div>

  <div class="print-info">
    <strong>Print Format:</strong> 10x10cm (Pixi style) - Saddle-stitch binding<br>
    <strong>Reading Level:</strong> Beginning readers (ages 5-7) - CVC words + sight words
  </div>

  <div class="hint">Use arrow keys to navigate</div>

  <script>
    let currentBook = null;
    let currentPage = 0;

    async function loadBook(bookKey) {
      try {
        const res = await fetch(`/books/${bookKey}.json`);
        if (res.ok) {
          currentBook = await res.json();
          currentBook.key = bookKey;
          currentBook.isV2 = bookKey.includes('_v2');
          currentPage = 0;
          renderPage();
          renderThumbnails();
          updateBadges();
          updateRisoInfo();
        }
      } catch (e) {
        console.error('Failed to load book:', e);
      }
    }

    function updateBadges() {
      const levelBadge = document.getElementById('levelBadge');
      const versionBadge = document.getElementById('versionBadge');

      // Level badge
      const wl = currentBook.word_list || {};
      const soundOut = wl.sound_out || [];
      let level = 'Level 1: CVC Words';
      if (soundOut.some(w => w.length > 4)) {
        level = 'Level 2: Blends';
      }
      levelBadge.textContent = level;

      // Version badge
      if (currentBook.isV2) {
        versionBadge.textContent = 'v2 RISO';
        versionBadge.className = 'version-badge v2';
      } else {
        versionBadge.textContent = 'v1';
        versionBadge.className = 'version-badge v1';
      }
    }

    function updateRisoInfo() {
      const risoInfo = document.getElementById('risoInfo');
      if (currentBook.isV2 && currentBook.riso_colors) {
        const colors = currentBook.riso_colors;
        let html = '<strong>Riso Colors:</strong> ';
        html += '<span class="color-chip" style="background:#000"></span>Black';
        if (colors.color_a) {
          const colorA = colors.color_a.name || 'Color A';
          const pantoneA = colors.color_a.pantone || '';
          html += ` + <span class="color-chip" style="background:${getColorHex(colorA)}"></span>${colorA}`;
        }
        if (colors.color_b) {
          const colorB = colors.color_b.name || 'Color B';
          html += ` + <span class="color-chip" style="background:${getColorHex(colorB)}"></span>${colorB}`;
        }
        risoInfo.innerHTML = html;
      } else {
        risoInfo.innerHTML = '';
      }
    }

    function getColorHex(colorName) {
      const colors = {
        'Fluorescent Orange': '#FF6B35',
        'Yellow': '#FFD700',
        'Fluorescent Pink': '#FF69B4',
        'Blue': '#4169E1',
        'Green': '#32CD32',
        'Risofederal Blue': '#3366CC'
      };
      return colors[colorName] || '#888';
    }

    function getImagePath(page) {
      if (currentBook.isV2) {
        // v2 books: construct path from book key and page number
        const bookBase = currentBook.key.replace('_v2', '');
        const pageNum = String(page.page).padStart(2, '0');
        return `/books/images_v2/${bookBase}_v2_page${pageNum}.png`;
      } else {
        // v1 books: use image field directly
        return page.image ? `/books/images/${page.image}` : null;
      }
    }

    function renderPage() {
      if (!currentBook) return;

      const page = currentBook.pages[currentPage];
      const container = document.getElementById('pageContainer');
      const imgPath = getImagePath(page);

      // WORD LIST PAGE
      if (page.type === 'wordlist') {
        const wl = currentBook.word_list;
        const makeWordBoxes = (words, cls) => (words || []).map(w =>
          `<span class="word-box ${cls}">${w}</span>`
        ).join('');

        container.innerHTML = `
          <div class="page-wordlist">
            <h2>Words to Know</h2>
            <div class="word-section">
              <div class="word-section-label sound-out">Sound Out These Words</div>
              <div class="word-boxes">${makeWordBoxes(wl.sound_out, 'sound-out')}</div>
            </div>
            <div class="word-section">
              <div class="word-section-label sight">Sight Words</div>
              <div class="word-boxes">${makeWordBoxes(wl.sight, 'sight')}</div>
            </div>
            <div class="word-section">
              <div class="word-section-label new">New Words</div>
              <div class="word-boxes">${makeWordBoxes(wl.new, 'new')}</div>
            </div>
            <div class="wordlist-footer">Practice these words before reading!</div>
          </div>
        `;
      }
      // COVER PAGE
      else if (page.type === 'cover') {
        container.innerHTML = `
          <div class="page-cover" style="display:flex;flex-direction:column;width:100%;height:100%;">
            <div class="image-area">
              ${imgPath ? `<img src="${imgPath}" alt="${currentBook.title}">` : ''}
            </div>
            <div class="text-area">
              <p>${page.text}</p>
            </div>
          </div>
        `;
      }
      // END PAGE
      else if (page.type === 'end') {
        container.innerHTML = `
          <div class="page-end" style="display:flex;flex-direction:column;width:100%;height:100%;">
            <div class="image-area">
              ${imgPath ? `<img src="${imgPath}" alt="">` : ''}
            </div>
            <div class="text-area">
              <p>${page.text}</p>
            </div>
          </div>
        `;
      }
      // STORY PAGES
      else {
        const displayText = page.text.replace(/\n/g, '<br>');
        container.innerHTML = `
          <div style="display:flex;flex-direction:column;width:100%;height:100%;">
            <div class="image-area">
              ${imgPath ? `<img src="${imgPath}" alt="">` : ''}
            </div>
            <div class="text-area">
              <p>${displayText}</p>
            </div>
          </div>
        `;
      }

      // Update controls
      document.getElementById('pageInfo').textContent = `Page ${currentPage + 1} / ${currentBook.pages.length}`;
      document.getElementById('prevBtn').disabled = currentPage === 0;
      document.getElementById('nextBtn').disabled = currentPage === currentBook.pages.length - 1;

      // Update thumbnail active state
      document.querySelectorAll('.thumb').forEach((t, i) => {
        t.classList.toggle('active', i === currentPage);
      });
    }

    function renderThumbnails() {
      if (!currentBook) return;

      const container = document.getElementById('thumbnails');
      container.innerHTML = currentBook.pages.map((page, i) => {
        const imgPath = getImagePath(page);
        const bgStyle = page.type === 'wordlist' ? 'background:linear-gradient(135deg,#FFFEF5,#FFF8E1);' : '';
        return `
          <div class="thumb ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})" style="${bgStyle}">
            ${imgPath ? `<img src="${imgPath}" alt="">` : '<span style="font-size:8px;color:#666;display:flex;align-items:center;justify-content:center;height:100%;">W</span>'}
            <span class="num">${i + 1}</span>
          </div>
        `;
      }).join('');
    }

    function goToPage(index) {
      currentPage = index;
      renderPage();
    }

    function prevPage() {
      if (currentPage > 0) {
        currentPage--;
        renderPage();
      }
    }

    function nextPage() {
      if (currentBook && currentPage < currentBook.pages.length - 1) {
        currentPage++;
        renderPage();
      }
    }

    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft') prevPage();
      if (e.key === 'ArrowRight') nextPage();
    });

    loadBook('volcano_v2');
  </script>
</body>
</html>
