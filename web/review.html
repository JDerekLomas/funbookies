<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Funbookies - Review</title>
  <link href="https://fonts.googleapis.com/css2?family=Andika:wght@400;700&family=Nunito:wght@700;800;900&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Andika', sans-serif;
      background: #1a1a2e;
      min-height: 100vh;
      padding: 20px;
      padding-bottom: 100px;
    }
    .header {
      text-align: center;
      margin-bottom: 20px;
    }
    .header h1 {
      font-family: 'Nunito', sans-serif;
      color: #FFB347;
    }
    .controls {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
      margin-bottom: 30px;
    }
    select, button {
      padding: 10px 20px;
      font-size: 1rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    select { background: white; }
    button { background: #667eea; color: white; font-weight: 700; }
    button:hover { background: #5a6fd6; }
    button.export { background: #4CAF50; }

    .pages-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 24px;
      max-width: 1600px;
      margin: 0 auto;
    }

    .review-card {
      background: #2a2a4e;
      border-radius: 12px;
      overflow: hidden;
      border: 4px solid #444;
    }
    .review-card.approved { border-color: #4CAF50; }
    .review-card.rejected { border-color: #f44336; }

    /* PRINT PAGE - exact 1:1 aspect ratio like actual print */
    .print-page {
      width: 100%;
      aspect-ratio: 1;
      background: white;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Image area - 65% */
    .print-image {
      flex: 65;
      background: #f0f0f0;
      overflow: hidden;
    }
    .print-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* Text area - 35% */
    .print-text {
      flex: 35;
      background: #FFFEF5;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 12px;
      border-top: 3px solid #FFB347;
    }
    .print-text p {
      font-family: 'Andika', sans-serif;
      font-size: 14px;
      color: #222;
      text-align: center;
      line-height: 1.3;
    }

    /* Cover page style */
    .print-page.cover .print-image { flex: 70; }
    .print-page.cover .print-text {
      flex: 30;
      background: linear-gradient(to bottom, #FFF8DC, #FFE4B5);
      border-top: 4px solid #FF6B35;
    }
    .print-page.cover .print-text p {
      font-family: 'Nunito', sans-serif;
      font-size: 16px;
      font-weight: 900;
      color: #D84315;
    }

    /* End page style */
    .print-page.end .print-image { flex: 70; }
    .print-page.end .print-text {
      flex: 30;
      background: linear-gradient(to bottom, #E8F5E9, #C8E6C9);
      border-top: 3px solid #4CAF50;
    }
    .print-page.end .print-text p {
      font-family: 'Nunito', sans-serif;
      font-size: 18px;
      font-weight: 800;
      color: #2E7D32;
    }

    /* Word list page */
    .print-page.wordlist {
      background: linear-gradient(135deg, #FFFEF5, #FFF8E1);
      padding: 15px;
      justify-content: center;
    }
    .print-page.wordlist h3 {
      font-family: 'Nunito', sans-serif;
      font-size: 14px;
      text-align: center;
      margin-bottom: 10px;
      color: #333;
    }
    .word-section { margin-bottom: 8px; }
    .word-label {
      font-size: 9px;
      font-weight: 700;
      text-transform: uppercase;
      margin-bottom: 4px;
    }
    .word-label.sound-out { color: #1565C0; }
    .word-label.sight { color: #7B1FA2; }
    .word-label.new { color: #E65100; }
    .word-boxes { display: flex; flex-wrap: wrap; gap: 4px; }
    .word-box {
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 700;
      border: 1px solid;
    }
    .word-box.sound-out { background: #E3F2FD; color: #0D47A1; border-color: #64B5F6; }
    .word-box.sight { background: #F3E5F5; color: #6A1B9A; border-color: #BA68C8; }
    .word-box.new { background: #FFF3E0; color: #BF360C; border-color: #FFB74D; }

    /* Review actions below page */
    .review-actions {
      padding: 12px;
      display: flex;
      gap: 8px;
      align-items: center;
      background: #2a2a4e;
    }
    .page-label {
      color: #FFB347;
      font-weight: 700;
      font-size: 0.85rem;
      min-width: 50px;
    }
    .vote-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 2px solid #444;
      background: #1a1a2e;
      cursor: pointer;
      font-size: 1.2rem;
      transition: all 0.2s;
    }
    .vote-btn:hover { transform: scale(1.1); border-color: #667eea; }
    .vote-btn.up.active { background: #4CAF50; border-color: #4CAF50; }
    .vote-btn.down.active { background: #f44336; border-color: #f44336; }
    .comment-input {
      flex: 1;
      padding: 8px 10px;
      border: 2px solid #444;
      border-radius: 6px;
      font-size: 0.85rem;
      background: #1a1a2e;
      color: white;
    }
    .comment-input:focus { border-color: #667eea; outline: none; }
    .comment-input::placeholder { color: #555; }

    /* Summary bar */
    .summary-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #2a2a4e;
      padding: 12px 20px;
      display: flex;
      justify-content: center;
      gap: 25px;
      align-items: center;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.4);
      z-index: 100;
    }
    .stat {
      display: flex;
      align-items: center;
      gap: 6px;
      color: white;
      font-size: 0.9rem;
    }
    .stat-num { font-weight: 700; }
    .stat.approved .stat-num { color: #4CAF50; }
    .stat.rejected .stat-num { color: #f44336; }
    .stat.pending .stat-num { color: #FFB347; }
    .copy-btn { background: #FF5722; }
  </style>
</head>
<body>
  <div class="header">
    <h1>Review Pages</h1>
  </div>

  <div class="controls">
    <select id="bookSelect" onchange="loadBook(this.value)">
      <optgroup label="v2 - Riso Print Ready">
        <option value="volcano_v2">Gus and the Volcano</option>
        <option value="castle_v2">Rats in the Castle</option>
        <option value="jungle_v2">Zee and the Jungle</option>
      </optgroup>
    </select>
    <button class="export" onclick="copyReview()">Copy Issues</button>
  </div>

  <div class="pages-grid" id="pagesGrid"></div>

  <div class="summary-bar">
    <div class="stat approved">üëç <span class="stat-num" id="approvedCount">0</span></div>
    <div class="stat rejected">üëé <span class="stat-num" id="rejectedCount">0</span></div>
    <div class="stat pending">‚è≥ <span class="stat-num" id="pendingCount">0</span></div>
    <button class="copy-btn" onclick="copyReview()">Copy Issues</button>
  </div>

  <script>
    let currentBook = null;
    let reviews = {};

    async function loadBook(bookKey) {
      const res = await fetch(`/books/${bookKey}.json`);
      if (res.ok) {
        currentBook = await res.json();
        currentBook.key = bookKey;
        currentBook.isV2 = bookKey.includes('_v2');
        const saved = localStorage.getItem(`review_${bookKey}`);
        reviews = saved ? JSON.parse(saved) : {};
        renderPages();
        updateSummary();
      }
    }

    function getImagePath(page) {
      if (currentBook.isV2) {
        const bookBase = currentBook.key.replace('_v2', '');
        const pageNum = String(page.page).padStart(2, '0');
        return `/books/images_v2/${bookBase}_v2_page${pageNum}.png`;
      }
      return page.image ? `/books/images/${page.image}` : null;
    }

    function renderWordList() {
      const wl = currentBook.word_list || {};
      const makeBoxes = (words, cls) => (words || []).map(w =>
        `<span class="word-box ${cls}">${w}</span>`
      ).join('');

      return `
        <h3>Words to Know</h3>
        <div class="word-section">
          <div class="word-label sound-out">Sound Out</div>
          <div class="word-boxes">${makeBoxes(wl.sound_out, 'sound-out')}</div>
        </div>
        <div class="word-section">
          <div class="word-label sight">Sight Words</div>
          <div class="word-boxes">${makeBoxes(wl.sight, 'sight')}</div>
        </div>
        <div class="word-section">
          <div class="word-label new">New Words</div>
          <div class="word-boxes">${makeBoxes(wl.new, 'new')}</div>
        </div>
      `;
    }

    function renderPages() {
      const grid = document.getElementById('pagesGrid');
      grid.innerHTML = currentBook.pages.map((page) => {
        const imgPath = getImagePath(page);
        const review = reviews[page.page] || { status: 'pending', comment: '' };
        const statusClass = review.status === 'approved' ? 'approved' : review.status === 'rejected' ? 'rejected' : '';
        const pageType = page.type || 'story';

        let printPageContent = '';

        if (pageType === 'wordlist') {
          printPageContent = `<div class="print-page wordlist">${renderWordList()}</div>`;
        } else {
          printPageContent = `
            <div class="print-page ${pageType}">
              <div class="print-image">
                ${imgPath ? `<img src="${imgPath}" alt="">` : ''}
              </div>
              <div class="print-text">
                <p>${page.text || ''}</p>
              </div>
            </div>
          `;
        }

        return `
          <div class="review-card ${statusClass}">
            ${printPageContent}
            <div class="review-actions">
              <span class="page-label">P${page.page}</span>
              <button class="vote-btn up ${review.status === 'approved' ? 'active' : ''}"
                      onclick="vote(${page.page}, 'approved')">üëç</button>
              <button class="vote-btn down ${review.status === 'rejected' ? 'active' : ''}"
                      onclick="vote(${page.page}, 'rejected')">üëé</button>
              <input type="text" class="comment-input"
                     placeholder="Comment..."
                     value="${review.comment || ''}"
                     onchange="updateComment(${page.page}, this.value)">
            </div>
          </div>
        `;
      }).join('');
    }

    function vote(pageNum, status) {
      if (!reviews[pageNum]) reviews[pageNum] = { status: 'pending', comment: '' };
      reviews[pageNum].status = reviews[pageNum].status === status ? 'pending' : status;
      saveReviews();
      renderPages();
      updateSummary();
    }

    function updateComment(pageNum, comment) {
      if (!reviews[pageNum]) reviews[pageNum] = { status: 'pending', comment: '' };
      reviews[pageNum].comment = comment;
      saveReviews();
    }

    function saveReviews() {
      localStorage.setItem(`review_${currentBook.key}`, JSON.stringify(reviews));
    }

    function updateSummary() {
      let approved = 0, rejected = 0, pending = 0;
      currentBook.pages.forEach(page => {
        const r = reviews[page.page];
        if (!r || r.status === 'pending') pending++;
        else if (r.status === 'approved') approved++;
        else rejected++;
      });
      document.getElementById('approvedCount').textContent = approved;
      document.getElementById('rejectedCount').textContent = rejected;
      document.getElementById('pendingCount').textContent = pending;
    }

    function copyReview() {
      const rejected = currentBook.pages.filter(p => reviews[p.page]?.status === 'rejected');
      if (rejected.length === 0) {
        navigator.clipboard.writeText('All pages look good!');
        alert('All pages look good!');
        return;
      }
      let text = `${currentBook.title} - ${rejected.length} pages need work:\n\n`;
      rejected.forEach(page => {
        const r = reviews[page.page];
        text += `Page ${page.page} ("${page.text}"): ${r.comment || 'needs revision'}\n`;
      });
      navigator.clipboard.writeText(text);
      alert('Copied to clipboard!');
    }

    loadBook('volcano_v2');
  </script>
</body>
</html>
