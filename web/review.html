<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Funbookies - Story Review</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Nunito', sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
      padding: 20px;
    }
    .container { max-width: 900px; margin: 0 auto; }

    header {
      text-align: center;
      padding: 20px;
      margin-bottom: 30px;
    }
    header h1 { color: #333; font-size: 2rem; }
    header p { color: #666; margin-top: 8px; }

    .book-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .book-tab {
      padding: 12px 24px;
      background: white;
      border: 2px solid #ddd;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }
    .book-tab:hover { border-color: #667eea; }
    .book-tab.active {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }
    .book-tab .status {
      font-size: 0.8rem;
      margin-left: 8px;
    }

    .review-panel {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .book-header {
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .book-header h2 { font-size: 1.5rem; }
    .book-header .character { opacity: 0.9; margin-top: 8px; font-size: 0.95rem; }

    .word-list-section {
      padding: 20px;
      background: #f8f9fa;
      border-bottom: 1px solid #eee;
    }
    .word-list-section h3 {
      font-size: 1rem;
      color: #333;
      margin-bottom: 15px;
    }
    .word-categories {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }
    .word-cat {
      background: white;
      padding: 12px;
      border-radius: 8px;
      border-left: 4px solid;
    }
    .word-cat.sound-out { border-color: #2196F3; }
    .word-cat.sight { border-color: #9C27B0; }
    .word-cat.new { border-color: #FF9800; }
    .word-cat h4 {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }
    .word-cat.sound-out h4 { color: #1565C0; }
    .word-cat.sight h4 { color: #7B1FA2; }
    .word-cat.new h4 { color: #E65100; }
    .word-cat .words {
      font-size: 0.9rem;
      color: #333;
      line-height: 1.6;
    }

    .pages-section {
      padding: 20px;
    }
    .pages-section h3 {
      font-size: 1rem;
      color: #333;
      margin-bottom: 15px;
    }

    .page-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
    }
    .page-card {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .page-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    }
    .page-preview {
      aspect-ratio: 1;
      position: relative;
      overflow: hidden;
    }
    .page-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .page-preview .no-image {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      color: #999;
      padding: 15px;
      text-align: center;
    }
    .page-preview.cover { background: #FFE4B5; }
    .page-preview.wordlist { background: #E8F5E9; }
    .page-preview.story { background: #FFF8E7; }
    .page-preview.copyright { background: #F5F5F5; }
    .page-text-overlay {
      position: absolute;
      bottom: 8%;
      left: 5%; right: 5%;
      background: rgba(255,255,255,0.95);
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 0.75rem;
      line-height: 1.4;
      text-align: center;
      max-height: 40%;
      overflow: hidden;
    }
    .page-text-overlay.center {
      bottom: auto;
      top: 50%;
      transform: translateY(-50%);
    }
    .page-text-overlay.cover-style {
      font-weight: 700;
      color: #FF6B35;
      font-size: 0.9rem;
    }
    .page-info {
      padding: 12px;
      border-top: 1px solid #eee;
    }
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .page-num {
      font-weight: 700;
      color: #667eea;
      font-size: 0.85rem;
    }
    .page-type {
      font-size: 0.65rem;
      color: #999;
      text-transform: uppercase;
      background: #f0f0f0;
      padding: 2px 6px;
      border-radius: 4px;
    }
    .page-prompt {
      font-size: 0.7rem;
      color: #888;
      line-height: 1.4;
      font-style: italic;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .page-rating {
      display: flex;
      gap: 8px;
    }
    .rating-btn {
      width: 36px;
      height: 36px;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.2rem;
      transition: all 0.2s;
      opacity: 0.4;
    }
    .rating-btn:hover { opacity: 0.7; transform: scale(1.1); }
    .rating-btn.selected { opacity: 1; transform: scale(1.15); }
    .rating-btn.up { background: #E8F5E9; }
    .rating-btn.up.selected { background: #4CAF50; }
    .rating-btn.meh { background: #FFF3E0; }
    .rating-btn.meh.selected { background: #FF9800; }
    .rating-btn.down { background: #FFEBEE; }
    .rating-btn.down.selected { background: #f44336; }

    .book-feedback {
      padding: 20px;
      border-top: 1px solid #eee;
      background: #fafafa;
    }
    .book-feedback h3 {
      font-size: 1rem;
      color: #333;
      margin-bottom: 15px;
    }
    .overall-rating {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
    }
    .overall-btn {
      padding: 12px 24px;
      border: 2px solid #ddd;
      border-radius: 8px;
      background: white;
      cursor: pointer;
      font-size: 1.5rem;
      transition: all 0.2s;
    }
    .overall-btn:hover { border-color: #667eea; }
    .overall-btn.selected.up { background: #4CAF50; border-color: #4CAF50; }
    .overall-btn.selected.meh { background: #FF9800; border-color: #FF9800; }
    .overall-btn.selected.down { background: #f44336; border-color: #f44336; }

    .comment-box {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-family: inherit;
      font-size: 0.95rem;
      resize: vertical;
      min-height: 80px;
    }
    .comment-box:focus {
      outline: none;
      border-color: #667eea;
    }

    .actions {
      padding: 20px;
      display: flex;
      gap: 15px;
      justify-content: flex-end;
      border-top: 1px solid #eee;
    }
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.2s;
    }
    .btn-primary {
      background: #667eea;
      color: white;
    }
    .btn-primary:hover { background: #5a6fd6; }
    .btn-secondary {
      background: #e0e0e0;
      color: #333;
    }
    .btn-secondary:hover { background: #d0d0d0; }

    .summary {
      margin-top: 30px;
      padding: 20px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.1);
    }
    .summary h3 { margin-bottom: 15px; }
    .summary-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      text-align: center;
    }
    .stat-box {
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
    }
    .stat-box .num { font-size: 2rem; font-weight: 700; }
    .stat-box .label { color: #666; font-size: 0.9rem; }
    .stat-box.approved .num { color: #4CAF50; }
    .stat-box.needs-work .num { color: #FF9800; }
    .stat-box.rejected .num { color: #f44336; }

    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 15px 25px;
      background: #333;
      color: white;
      border-radius: 8px;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .toast.show { opacity: 1; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Story Review</h1>
      <p>Review and rate each book before generating images</p>
    </header>

    <div class="book-tabs" id="bookTabs"></div>

    <div class="review-panel" id="reviewPanel">
      <div class="book-header">
        <h2 id="bookTitle">Loading...</h2>
        <div class="character" id="bookCharacter"></div>
      </div>

      <div class="word-list-section">
        <h3>Word List</h3>
        <div class="word-categories" id="wordCategories"></div>
      </div>

      <div class="pages-section">
        <h3>Story Pages</h3>
        <div class="page-grid" id="pageGrid"></div>
      </div>

      <div class="book-feedback">
        <h3>Overall Rating</h3>
        <div class="overall-rating">
          <button class="overall-btn up" onclick="setOverallRating('up')">üëç</button>
          <button class="overall-btn meh" onclick="setOverallRating('meh')">üòê</button>
          <button class="overall-btn down" onclick="setOverallRating('down')">üëé</button>
        </div>
        <textarea class="comment-box" id="bookComment" placeholder="Optional: Add notes about this story..."></textarea>
      </div>

      <div class="actions">
        <button class="btn btn-secondary" onclick="exportFeedback()">Export Feedback</button>
        <button class="btn btn-primary" onclick="saveFeedback()">Save & Continue</button>
      </div>
    </div>

    <div class="summary" id="summary" style="display:none;">
      <h3>Review Summary</h3>
      <div class="summary-stats">
        <div class="stat-box approved">
          <div class="num" id="approvedCount">0</div>
          <div class="label">Approved</div>
        </div>
        <div class="stat-box needs-work">
          <div class="num" id="mehCount">0</div>
          <div class="label">Needs Work</div>
        </div>
        <div class="stat-box rejected">
          <div class="num" id="rejectedCount">0</div>
          <div class="label">Rejected</div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    let books = [];
    let currentBookIndex = 0;
    let feedback = {};

    // Load saved feedback from localStorage
    const savedFeedback = localStorage.getItem('funbookies_feedback');
    if (savedFeedback) {
      feedback = JSON.parse(savedFeedback);
    }

    async function loadBooks() {
      const bookFiles = ['volcano_story.json', 'castles_story.json', 'jungle_story.json'];

      for (const file of bookFiles) {
        try {
          const res = await fetch(`/books/${file}`);
          if (res.ok) {
            const book = await res.json();
            book.file = file;
            books.push(book);
          }
        } catch (e) {
          console.log(`Could not load ${file}`);
        }
      }

      if (books.length > 0) {
        renderTabs();
        renderBook(0);
        updateSummary();
      } else {
        document.getElementById('reviewPanel').innerHTML = `
          <div style="padding: 40px; text-align: center; color: #666;">
            <p>No books found. Generate stories first using:</p>
            <code style="background: #f0f0f0; padding: 8px 16px; border-radius: 4px; margin-top: 10px; display: inline-block;">
              python src/book_maker.py
            </code>
          </div>
        `;
      }
    }

    function renderTabs() {
      const tabsDiv = document.getElementById('bookTabs');
      tabsDiv.innerHTML = books.map((book, i) => {
        const fb = feedback[book.file] || {};
        let statusIcon = '';
        if (fb.overall === 'up') statusIcon = '<span class="status">üëç</span>';
        else if (fb.overall === 'meh') statusIcon = '<span class="status">üòê</span>';
        else if (fb.overall === 'down') statusIcon = '<span class="status">üëé</span>';

        return `<button class="book-tab ${i === currentBookIndex ? 'active' : ''}" onclick="switchBook(${i})">
          ${book.title}${statusIcon}
        </button>`;
      }).join('');
    }

    function switchBook(index) {
      saveFeedbackSilent();
      currentBookIndex = index;
      renderTabs();
      renderBook(index);
    }

    function renderBook(index) {
      const book = books[index];
      const fb = feedback[book.file] || { pages: {}, overall: null, comment: '' };

      document.getElementById('bookTitle').textContent = book.title;
      document.getElementById('bookCharacter').textContent = book.character || '';

      // Word list
      const wl = book.word_list || {};
      const catDiv = document.getElementById('wordCategories');
      let catHTML = '';

      const soundOut = wl.sound_out || wl.phonetic || [];
      const sight = wl.sight || [];
      const newWords = wl.new || wl.special || [];

      if (soundOut.length) {
        catHTML += `<div class="word-cat sound-out">
          <h4>Sound-out words</h4>
          <div class="words">${soundOut.join(', ')}</div>
        </div>`;
      }
      if (sight.length) {
        catHTML += `<div class="word-cat sight">
          <h4>Sight words</h4>
          <div class="words">${sight.join(', ')}</div>
        </div>`;
      }
      if (newWords.length) {
        catHTML += `<div class="word-cat new">
          <h4>New words</h4>
          <div class="words">${newWords.join(', ')}</div>
        </div>`;
      }
      catDiv.innerHTML = catHTML || '<p style="color:#999;">No word list defined</p>';

      // Pages
      const pageGrid = document.getElementById('pageGrid');
      const slug = book.file.replace('_story.json', '');

      pageGrid.innerHTML = book.pages.map(page => {
        const pageRating = fb.pages[page.page] || null;
        const imgPath = `/books/images/${slug}_page${String(page.page).padStart(2, '0')}.png`;
        const isCenter = ['cover', 'wordlist', 'wordlist_title', 'copyright'].includes(page.type);
        const isCover = page.type === 'cover';

        return `<div class="page-card">
          <div class="page-preview ${page.type}">
            <img src="${imgPath}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" alt="">
            <div class="no-image" style="display:none;">${escapeHtml(page.image_prompt || 'No image prompt')}</div>
            <div class="page-text-overlay ${isCenter ? 'center' : ''} ${isCover ? 'cover-style' : ''}">
              ${escapeHtml(page.text)}
            </div>
          </div>
          <div class="page-info">
            <div class="page-header">
              <span class="page-num">Page ${page.page}</span>
              <span class="page-type">${page.type}</span>
            </div>
            <div class="page-rating" style="justify-content: center;">
              <button class="rating-btn up ${pageRating === 'up' ? 'selected' : ''}" onclick="ratePage(${page.page}, 'up')">üëç</button>
              <button class="rating-btn meh ${pageRating === 'meh' ? 'selected' : ''}" onclick="ratePage(${page.page}, 'meh')">üòê</button>
              <button class="rating-btn down ${pageRating === 'down' ? 'selected' : ''}" onclick="ratePage(${page.page}, 'down')">üëé</button>
            </div>
          </div>
        </div>`;
      }).join('');

      // Overall rating & comment
      document.querySelectorAll('.overall-btn').forEach(btn => {
        btn.classList.remove('selected');
        if (fb.overall && btn.classList.contains(fb.overall)) {
          btn.classList.add('selected');
        }
      });
      document.getElementById('bookComment').value = fb.comment || '';
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function ratePage(pageNum, rating) {
      const book = books[currentBookIndex];
      if (!feedback[book.file]) {
        feedback[book.file] = { pages: {}, overall: null, comment: '' };
      }

      // Toggle off if clicking same rating
      if (feedback[book.file].pages[pageNum] === rating) {
        delete feedback[book.file].pages[pageNum];
      } else {
        feedback[book.file].pages[pageNum] = rating;
      }

      renderBook(currentBookIndex);
      saveFeedbackSilent();
    }

    function setOverallRating(rating) {
      const book = books[currentBookIndex];
      if (!feedback[book.file]) {
        feedback[book.file] = { pages: {}, overall: null, comment: '' };
      }

      // Toggle off if clicking same rating
      if (feedback[book.file].overall === rating) {
        feedback[book.file].overall = null;
      } else {
        feedback[book.file].overall = rating;
      }

      renderBook(currentBookIndex);
      renderTabs();
      saveFeedbackSilent();
      updateSummary();
    }

    function saveFeedbackSilent() {
      const book = books[currentBookIndex];
      if (!feedback[book.file]) {
        feedback[book.file] = { pages: {}, overall: null, comment: '' };
      }
      feedback[book.file].comment = document.getElementById('bookComment').value;
      localStorage.setItem('funbookies_feedback', JSON.stringify(feedback));
    }

    function saveFeedback() {
      saveFeedbackSilent();
      showToast('Feedback saved!');

      // Move to next book if available
      if (currentBookIndex < books.length - 1) {
        switchBook(currentBookIndex + 1);
      }
    }

    function updateSummary() {
      let approved = 0, meh = 0, rejected = 0;

      books.forEach(book => {
        const fb = feedback[book.file];
        if (fb) {
          if (fb.overall === 'up') approved++;
          else if (fb.overall === 'meh') meh++;
          else if (fb.overall === 'down') rejected++;
        }
      });

      document.getElementById('approvedCount').textContent = approved;
      document.getElementById('mehCount').textContent = meh;
      document.getElementById('rejectedCount').textContent = rejected;

      if (approved + meh + rejected > 0) {
        document.getElementById('summary').style.display = 'block';
      }
    }

    function exportFeedback() {
      const exportData = {
        timestamp: new Date().toISOString(),
        books: books.map(book => ({
          title: book.title,
          file: book.file,
          feedback: feedback[book.file] || null
        }))
      };

      const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `funbookies_review_${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);

      showToast('Feedback exported!');
    }

    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2000);
    }

    loadBooks();
  </script>
</body>
</html>
