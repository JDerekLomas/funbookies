<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Funbookies - Review</title>
  <link href="https://fonts.googleapis.com/css2?family=Andika:wght@400;700&family=Nunito:wght@700;800;900&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Andika', sans-serif;
      background: #1a1a2e;
      min-height: 100vh;
      padding: 20px;
      padding-bottom: 120px;
    }
    .header {
      text-align: center;
      margin-bottom: 10px;
    }
    .header h1 {
      font-family: 'Nunito', sans-serif;
      font-size: 2.5rem;
      color: #FFB347;
      margin-bottom: 5px;
    }
    .header .subtitle {
      color: #888;
      font-size: 0.9rem;
    }

    /* Parent instructions */
    .parent-guide {
      max-width: 800px;
      margin: 0 auto 25px;
      background: #2a2a4e;
      border-radius: 12px;
      padding: 20px;
      border-left: 4px solid #FFB347;
    }
    .parent-guide h2 {
      font-family: 'Nunito', sans-serif;
      color: #FFB347;
      font-size: 1.1rem;
      margin-bottom: 10px;
    }
    .parent-guide p {
      color: #ccc;
      font-size: 0.9rem;
      line-height: 1.5;
      margin-bottom: 8px;
    }
    .parent-guide ul {
      color: #aaa;
      font-size: 0.85rem;
      margin-left: 20px;
      line-height: 1.6;
    }

    .controls {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
      margin-bottom: 30px;
    }
    select, button {
      padding: 12px 24px;
      font-size: 1rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-family: 'Nunito', sans-serif;
      font-weight: 700;
    }
    select { background: white; }
    button { background: #667eea; color: white; }
    button:hover { background: #5a6fd6; }
    button.export { background: #4CAF50; }

    .pages-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 24px;
      max-width: 1600px;
      margin: 0 auto;
    }

    .review-card {
      background: #2a2a4e;
      border-radius: 12px;
      overflow: hidden;
      border: 4px solid #444;
    }
    .review-card.approved { border-color: #4CAF50; }
    .review-card.rejected { border-color: #f44336; }

    /* PRINT PAGE - exact 1:1 aspect ratio like actual print */
    .print-page {
      width: 100%;
      aspect-ratio: 1;
      background: white;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Image area - 65% */
    .print-image {
      flex: 65;
      background: #f0f0f0;
      overflow: hidden;
    }
    .print-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* Text area - 35% */
    .print-text {
      flex: 35;
      background: #FFFEF5;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 15px;
      border-top: 3px solid #FFB347;
    }
    .print-text p {
      font-family: 'Andika', sans-serif;
      font-size: 18px;
      color: #222;
      text-align: center;
      line-height: 1.4;
    }

    /* Cover page style */
    .print-page.cover .print-image { flex: 65; }
    .print-page.cover .print-text {
      flex: 35;
      background: linear-gradient(to bottom, #FFF8DC, #FFE4B5);
      border-top: 4px solid #FF6B35;
      flex-direction: column;
      gap: 4px;
    }
    .print-page.cover .print-text p {
      font-family: 'Nunito', sans-serif;
      font-size: 22px;
      font-weight: 900;
      color: #D84315;
    }
    .print-page.cover .print-text .copyright {
      font-family: 'Andika', sans-serif;
      font-size: 9px;
      color: #666;
      font-weight: 400;
    }

    /* End page style */
    .print-page.end .print-image { flex: 65; }
    .print-page.end .print-text {
      flex: 35;
      background: linear-gradient(to bottom, #E8F5E9, #C8E6C9);
      border-top: 3px solid #4CAF50;
      flex-direction: column;
      gap: 8px;
    }
    .print-page.end .print-text p {
      font-family: 'Nunito', sans-serif;
      font-size: 24px;
      font-weight: 800;
      color: #2E7D32;
    }
    .print-page.end .print-text .copyright {
      font-family: 'Andika', sans-serif;
      font-size: 9px;
      color: #555;
      font-weight: 400;
    }

    /* Word list page */
    .print-page.wordlist {
      background: linear-gradient(135deg, #FFFEF5, #FFF8E1);
      padding: 12px;
      justify-content: center;
    }
    .print-page.wordlist h3 {
      font-family: 'Nunito', sans-serif;
      font-size: 14px;
      text-align: center;
      margin-bottom: 8px;
      color: #333;
    }
    .word-section { margin-bottom: 6px; }
    .word-label {
      font-size: 9px;
      font-weight: 700;
      text-transform: uppercase;
      margin-bottom: 3px;
    }
    .word-label.sound-out { color: #1565C0; }
    .word-label.sight { color: #7B1FA2; }
    .word-label.new { color: #E65100; }
    .word-boxes { display: flex; flex-wrap: wrap; gap: 4px; }
    .word-box {
      padding: 3px 6px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 700;
      border: 1px solid;
    }
    .word-box.sound-out { background: #E3F2FD; color: #0D47A1; border-color: #64B5F6; }
    .word-box.sight { background: #F3E5F5; color: #6A1B9A; border-color: #BA68C8; }
    .word-box.new { background: #FFF3E0; color: #BF360C; border-color: #FFB74D; }

    /* Review actions below page */
    .review-actions {
      padding: 12px 15px;
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: flex-start;
      background: #2a2a4e;
    }
    .page-label {
      color: #FFB347;
      font-family: 'Nunito', sans-serif;
      font-weight: 800;
      font-size: 1rem;
      min-width: 45px;
    }
    .vote-buttons {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .vote-btn {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      border: 2px solid #444;
      background: #1a1a2e;
      cursor: pointer;
      font-size: 1.1rem;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      line-height: 1;
    }
    .vote-btn:hover { transform: scale(1.1); border-color: #667eea; }
    .vote-btn.up.active { background: #4CAF50; border-color: #4CAF50; }
    .vote-btn.down.active { background: #f44336; border-color: #f44336; }
    .comment-input {
      flex: 1;
      padding: 10px 12px;
      border: 2px solid #444;
      border-radius: 8px;
      font-size: 0.9rem;
      font-family: 'Andika', sans-serif;
      background: #1a1a2e;
      color: white;
    }
    .comment-input:focus { border-color: #667eea; outline: none; }
    .comment-input::placeholder { color: #666; }

    /* Summary bar */
    .summary-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #2a2a4e;
      padding: 15px 20px;
      display: flex;
      justify-content: center;
      gap: 30px;
      align-items: center;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.5);
      z-index: 100;
    }
    .stat {
      display: flex;
      align-items: center;
      gap: 8px;
      color: white;
      font-size: 1rem;
      font-family: 'Nunito', sans-serif;
    }
    .stat-num { font-weight: 800; font-size: 1.2rem; }
    .stat.approved .stat-num { color: #4CAF50; }
    .stat.rejected .stat-num { color: #f44336; }
    .stat.pending .stat-num { color: #FFB347; }
    .copy-btn { background: #FF5722; padding: 12px 20px; }
    .copy-btn:hover { background: #E64A19; }

    /* Reference section */
    .reference-section {
      max-width: 1000px;
      margin: 0 auto 30px;
      background: #2a2a4e;
      border-radius: 12px;
      padding: 20px;
    }
    .reference-section h2 {
      font-family: 'Nunito', sans-serif;
      color: #FFB347;
      font-size: 1.2rem;
      margin-bottom: 15px;
      text-align: center;
    }
    .reference-images {
      display: flex;
      gap: 15px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .reference-images img {
      max-height: 200px;
      border-radius: 8px;
      border: 2px solid #444;
    }
    .ref-card {
      text-align: center;
    }
    .ref-card .ref-label {
      color: #aaa;
      font-size: 0.8rem;
      margin-top: 8px;
    }

    /* Footer */
    .footer {
      text-align: center;
      padding: 30px 20px 100px;
      color: #555;
      font-size: 0.8rem;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Fun Bookies Review</h1>
    <div class="subtitle">Riso Print Preview</div>
  </div>

  <div class="parent-guide">
    <h2>For Parents</h2>
    <p>These books are designed for early readers learning to sound out words. Each page shows exactly how it will look when printed.</p>
    <ul>
      <li><strong>Sound Out words</strong> (blue) - Practice blending these letter sounds</li>
      <li><strong>Sight Words</strong> (purple) - Common words to recognize by sight</li>
      <li><strong>New Words</strong> (orange) - Vocabulary introduced in this story</li>
    </ul>
    <p>Review each page below. Click thumbs up/down and add comments to help improve the book!</p>
  </div>

  <div class="controls">
    <select id="bookSelect" onchange="loadBook(this.value)">
      <optgroup label="v2 - Riso Print Ready">
        <option value="volcano_v2">Gus and the Volcano</option>
        <option value="castle_v2">Rats in the Castle</option>
        <option value="jungle_v2">Zee and the Jungle</option>
      </optgroup>
    </select>
    <button class="export" onclick="copyReview()">Copy Feedback</button>
  </div>

  <div class="reference-section" id="referenceSection">
    <h2>Character Reference</h2>
    <div class="reference-images" id="referenceImages"></div>
  </div>

  <div class="pages-grid" id="pagesGrid"></div>

  <div class="footer">
    &copy; 2025 Derek Lomas / Fun Bookies. All rights reserved.
  </div>

  <div class="summary-bar">
    <div class="stat approved"><span class="stat-num" id="approvedCount">0</span> approved</div>
    <div class="stat rejected"><span class="stat-num" id="rejectedCount">0</span> issues</div>
    <div class="stat pending"><span class="stat-num" id="pendingCount">0</span> pending</div>
    <button class="copy-btn" onclick="copyReview()">Copy Feedback</button>
  </div>

  <script>
    let currentBook = null;
    let reviews = {};

    // Reference images for each book
    const REFERENCE_IMAGES = {
      'volcano': [
        { src: '/reference_images/gus_ref_01.png', label: 'Gus the Salamander' },
        { src: '/reference_images/gus_ref_02.png', label: 'Gus (poses)' },
        { src: '/reference_images/volcano_ref_01.png', label: 'Volcano scene' },
        { src: '/reference_images/volcano_ref_02.png', label: 'Mountain/volcano' }
      ],
      'castle': [
        { src: '/reference_images/rita_ref_01.png', label: 'Rita (pink, bow)' },
        { src: '/reference_images/rita_ref_02.png', label: 'Rita (poses)' },
        { src: '/reference_images/rico_ref_01.png', label: 'Rico (blue, bandana)' },
        { src: '/reference_images/rico_ref_02.png', label: 'Rico (poses)' },
        { src: '/reference_images/cat_ref_01.png', label: 'The Cat' },
        { src: '/reference_images/castle_ref_01.png', label: 'Castle scene' }
      ],
      'jungle': []
    };

    function renderReferenceImages(bookKey) {
      const bookBase = bookKey.replace('_v2', '');
      const refs = REFERENCE_IMAGES[bookBase] || [];
      const container = document.getElementById('referenceImages');

      if (refs.length === 0) {
        document.getElementById('referenceSection').style.display = 'none';
        return;
      }

      document.getElementById('referenceSection').style.display = 'block';
      container.innerHTML = refs.map(ref => `
        <div class="ref-card">
          <img src="${ref.src}" alt="${ref.label}">
          <div class="ref-label">${ref.label}</div>
        </div>
      `).join('');
    }

    async function loadBook(bookKey) {
      const res = await fetch(`/books/${bookKey}.json`);
      if (res.ok) {
        currentBook = await res.json();
        currentBook.key = bookKey;
        currentBook.isV2 = bookKey.includes('_v2');
        const saved = localStorage.getItem(`review_${bookKey}`);
        reviews = saved ? JSON.parse(saved) : {};
        renderReferenceImages(bookKey);
        renderPages();
        updateSummary();
      }
    }

    function getImagePath(page) {
      if (currentBook.isV2) {
        const bookBase = currentBook.key.replace('_v2', '');
        const pageNum = String(page.page).padStart(2, '0');
        return `/books/images_v2/${bookBase}_v2_page${pageNum}.png`;
      }
      return page.image ? `/books/images/${page.image}` : null;
    }

    function renderWordList() {
      const wl = currentBook.word_list || {};
      const makeBoxes = (words, cls) => (words || []).map(w =>
        `<span class="word-box ${cls}">${w}</span>`
      ).join('');

      return `
        <h3>Words to Know</h3>
        <div class="word-section">
          <div class="word-label sound-out">Sound Out</div>
          <div class="word-boxes">${makeBoxes(wl.sound_out, 'sound-out')}</div>
        </div>
        <div class="word-section">
          <div class="word-label sight">Sight Words</div>
          <div class="word-boxes">${makeBoxes(wl.sight, 'sight')}</div>
        </div>
        <div class="word-section">
          <div class="word-label new">New Words</div>
          <div class="word-boxes">${makeBoxes(wl.new, 'new')}</div>
        </div>
      `;
    }

    function renderPages() {
      const grid = document.getElementById('pagesGrid');
      grid.innerHTML = currentBook.pages.map((page) => {
        const imgPath = getImagePath(page);
        const review = reviews[page.page] || { status: 'pending', comment: '' };
        const statusClass = review.status === 'approved' ? 'approved' : review.status === 'rejected' ? 'rejected' : '';
        const pageType = page.type || 'story';

        let printPageContent = '';
        const copyright = '<span class="copyright">&copy; 2025 Derek Lomas / Fun Bookies</span>';

        if (pageType === 'wordlist') {
          printPageContent = `<div class="print-page wordlist">${renderWordList()}</div>`;
        } else if (pageType === 'cover') {
          printPageContent = `
            <div class="print-page cover">
              <div class="print-image">
                ${imgPath ? `<img src="${imgPath}" alt="">` : ''}
              </div>
              <div class="print-text">
                <p>${page.text || ''}</p>
                ${copyright}
              </div>
            </div>
          `;
        } else if (pageType === 'end') {
          printPageContent = `
            <div class="print-page end">
              <div class="print-image">
                ${imgPath ? `<img src="${imgPath}" alt="">` : ''}
              </div>
              <div class="print-text">
                <p>${page.text || ''}</p>
                ${copyright}
              </div>
            </div>
          `;
        } else {
          printPageContent = `
            <div class="print-page ${pageType}">
              <div class="print-image">
                ${imgPath ? `<img src="${imgPath}" alt="">` : ''}
              </div>
              <div class="print-text">
                <p>${page.text || ''}</p>
              </div>
            </div>
          `;
        }

        return `
          <div class="review-card ${statusClass}">
            ${printPageContent}
            <div class="review-actions">
              <span class="page-label">P${page.page}</span>
              <div class="vote-buttons">
                <button class="vote-btn up ${review.status === 'approved' ? 'active' : ''}"
                        onclick="vote(${page.page}, 'approved')">&#x1F44D;</button>
                <button class="vote-btn down ${review.status === 'rejected' ? 'active' : ''}"
                        onclick="vote(${page.page}, 'rejected')">&#x1F44E;</button>
              </div>
              <input type="text" class="comment-input"
                     placeholder="Add comment..."
                     value="${review.comment || ''}"
                     onchange="updateComment(${page.page}, this.value)">
            </div>
          </div>
        `;
      }).join('');
    }

    function vote(pageNum, status) {
      if (!reviews[pageNum]) reviews[pageNum] = { status: 'pending', comment: '' };
      reviews[pageNum].status = reviews[pageNum].status === status ? 'pending' : status;
      saveReviews();
      renderPages();
      updateSummary();
    }

    function updateComment(pageNum, comment) {
      if (!reviews[pageNum]) reviews[pageNum] = { status: 'pending', comment: '' };
      reviews[pageNum].comment = comment;
      saveReviews();
    }

    function saveReviews() {
      localStorage.setItem(`review_${currentBook.key}`, JSON.stringify(reviews));
    }

    function updateSummary() {
      let approved = 0, rejected = 0, pending = 0;
      currentBook.pages.forEach(page => {
        const r = reviews[page.page];
        if (!r || r.status === 'pending') pending++;
        else if (r.status === 'approved') approved++;
        else rejected++;
      });
      document.getElementById('approvedCount').textContent = approved;
      document.getElementById('rejectedCount').textContent = rejected;
      document.getElementById('pendingCount').textContent = pending;
    }

    function copyReview() {
      const approved = currentBook.pages.filter(p => reviews[p.page]?.status === 'approved');
      const rejected = currentBook.pages.filter(p => reviews[p.page]?.status === 'rejected');
      const pending = currentBook.pages.filter(p => !reviews[p.page] || reviews[p.page].status === 'pending');

      let text = `# ${currentBook.title} - Review Feedback\n\n`;
      text += `**Summary:** ${approved.length} approved, ${rejected.length} issues, ${pending.length} pending\n\n`;

      if (rejected.length > 0) {
        text += `## Issues to Fix (${rejected.length})\n\n`;
        rejected.forEach(page => {
          const r = reviews[page.page];
          text += `- **Page ${page.page}** "${page.text}"\n`;
          text += `  ${r.comment || 'Needs revision'}\n\n`;
        });
      }

      if (approved.length > 0) {
        const approvedWithComments = approved.filter(p => reviews[p.page]?.comment);
        if (approvedWithComments.length > 0) {
          text += `## Approved with Notes\n\n`;
          approvedWithComments.forEach(page => {
            const r = reviews[page.page];
            text += `- **Page ${page.page}**: ${r.comment}\n`;
          });
          text += '\n';
        }
      }

      if (pending.length > 0 && pending.length < currentBook.pages.length) {
        text += `## Still Need Review\n\n`;
        text += `Pages: ${pending.map(p => p.page).join(', ')}\n\n`;
      }

      text += `---\n*Reviewed on ${new Date().toLocaleDateString()}*`;

      navigator.clipboard.writeText(text).then(() => {
        alert('Feedback copied to clipboard!');
      });
    }

    loadBook('volcano_v2');
  </script>
</body>
</html>
